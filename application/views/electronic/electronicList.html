<style type="text/css" media="screen">

.am-selected{

width: 100%!important;

}

.table-check{

width: 30px;

}

.hf-dropdown{ 

font-size: 12px!important;

padding: 5px 6px!important;

}

td img{

    width: 150px;

    height: 150px;

}

.afterSales {

    border: 1px solid #e0690c !important;

    color: #e0690c !important;

}



</style>



<!-- 内容区域 -->

<div class="tpl-content-wrapper">

<div class="container-fluid am-cf">

    <div class="row">

        <div class="am-u-sm-12 am-u-md-12 am-u-lg-9">

            <div class="page-header-heading"><span class="am-icon-home page-header-heading-icon"></span> 电子券管理 

            <a href="<?php echo site_url().'/electronic/electronic';?>" style="font-size:18px;">电子券列表</a>

            <small></small></div>

        </div>

    </div>

</div>

<div class="row-content am-cf">

    <div class="row">

        <div class="am-u-sm-12 am-u-md-12 am-u-lg-12">

            <div class="widget am-cf">

                <div class="widget-head am-cf">

                    <div class="widget-title  am-cf">电子券查询</div>

                </div>

                <form class="am-form am-form-horizontal am-padding-sm am-text-sm" >

                    <div class="am-form-group am-u-sm-4 am-u-md-4 am-u-lg-4">

                        <label for="source_state" class="am-u-sm-3 am-form-label">城市：</label>

                        <div class="am-u-sm-9">

                            <select id="city" name="city">

                                <option value="">请选择</option>
                                <option value="1">重庆</option>
                                <option value="2">南江</option>
                                <option value="3">宣汉</option>
                                <option value="4">邻水</option>
                                <option value="5">电商通用卷</option>

                            </select>

                        </div>

                    </div>
                    <div class="am-form-group am-u-sm-4 am-u-md-4 am-u-lg-4">

                        <label for="source_state" class="am-u-sm-3 am-form-label">商家：</label>

                        <div class="am-u-sm-9">

                            <select id="store_id" name="store_id"  data-am-selected="{searchBox: 1,maxHeight: 100}">
                                <option value="">请选择</option>
                                <?php foreach($store as $val):?>
                                    <option value="<?php echo $val['store_id'];?>"><?php echo $val['store_name'];?></option>
                                <?php endforeach;?>
                            </select>
                        </div>
                    </div>

                    <div class="am-form-group am-u-sm-4 am-u-md-4 am-u-lg-4 am-text-center">

                        <button type="button" class="am-btn am-btn-secondary searchSales"><i class="am-icon-search"></i> 查询</button>

                    </div>

                </form>

                <div class="widget-head am-cf">

                    <div class="widget-title  am-cf" style="clear:both;">电子券列表</div>

                </div>

                <div class="widget-body  am-fr">

                    <div class="am-u-sm-12 am-u-md-6 am-u-lg-6">

                        <div class="am-form-group">

                            <div class="am-btn-toolbar">

                                <div class="am-btn-group am-btn-group-xs">

                                    <button type="button" class="am-btn am-btn-default am-btn-success"><a href="<?php echo site_url().'/electronic/electronic/addElectronic';?>"><span class="am-icon-plus"></span> 新增</a></button>  
                                    <a type="button" class="am-btn am-btn-default am-btn-secondary am-btn-xs" data-am-modal="{target: '#exportFile'}"><span class="am-icon-arrow-up" ></span> 导出核销纪录</a>  
                                    <a type="button" class="am-btn am-btn-default am-btn-delete" data-am-modal="{target: '#receive'}"><span class="am-icon-arrow-up" ></span> 导出领取纪录</a>  


                                </div>

                                <div class="am-modal am-modal-confirm" tabindex="-1" id="exportFile">
                                    <div class="am-modal-dialog">
                                         <form class="am-form tpl-form-line-form" action="<?php echo site_url('/electronic/Electronic/Dow_electronicAfterSales');?>" method="post">
                                        <div class="am-modal-hd">导出核销记录</div>
                                         
                                             <div class="am-modal-bd">
                                              
                                                <div class="am-form-group am-cf" style="min-height: 100px;">
                                                    <label class="am-u-sm-2 am-form-label">商家：</label>
                                                    <div class="am-u-sm-9 am-u-end">
                                                        <select id="mollseller" name="store_id" data-am-selected="{searchBox: 1,maxHeight:200}">
                                                            <option value="">请选择/搜索</option>
                                                            <?php foreach($store as $val): ?>
                                                            <option value="<?php echo $val['business_id'];?>"><?php echo $val['store_name']?></option>
                                                            <?php endforeach;?>
                                                        </select>
                                                    </div>
                                                </div> 
                                             
                                                <div class="am-form-group am-cf" style="min-height: 100px;">
                                                    <label class="am-u-sm-2 am-form-label">优惠卷：</label>
                                                    <div class="am-u-sm-9 am-u-end">
                                                        <select id="mollseller"  name="couponid" data-am-selected="{searchBox: 1,maxHeight:200}">
                                                            <option value="">请选择/搜索</option>
                                                            <?php foreach($coupon as $val): ?>
                                                            <option value="<?php echo $val['id'];?>"><?php echo $val['title'].'-'. $val['name']?></option>
                                                            <?php endforeach;?>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="am-form-group am-cf">
                                                    <label for="businessTime" class="am-u-sm-2 am-form-label">时间：</label>
                                                    <div class="am-u-sm-9 am-u-end">
                                                        <div class="am-alert am-alert-danger" id="lineTime1" style="display: none">
                                                          <p>开始日期应小于结束日期！</p>
                                                        </div>
                                                        <div class="am-g">
                                                          <div class="am-u-sm-6">
                                                            <button type="button" class="am-btn am-btn-default am-btn-secondary am-btn-xs" id="my-start1">开始日期</button><input type="hidden" id="begin_date1" name="begin_time" value="" /><span id="my-startDate1">2017-01-01</span>
                                                          </div>
                                                          <div class="am-u-sm-6">
                                                            <button type="button" class="am-btn am-btn-default am-btn-secondary am-btn-xs" id="my-end1">结束日期</button><input type="hidden" id="end_date1" name="end_time" value="" /><span id="my-endDate1">2017-12-31</span>
                                                          </div>
                                                          <small class="red redtips">请先选择结束日期</small>
                                                        </div>
                                                    </div>
                                                    
                                                </div>
                                                <div class="am-form-group am-cf">
                                                    <button class="am-btn am-btn-default am-btn-xs" type="button" data-am-modal-cancel>取消</button>
                                                    <button class="am-btn am-btn-xs am-btn-secondary" type="submit" data-am-modal-confirm>确定</button>
                                                </div>
                                           
                                        </div>
                                       </form>
                                    </div>
                                </div>
                                <div class="am-modal am-modal-confirm" tabindex="-1" id="receive">
                                    <div class="am-modal-dialog">
                                         <form class="am-form tpl-form-line-form" action="<?php echo site_url('/electronic/Electronic/Dow_AllReceive');?>" method="post">
                                        <div class="am-modal-hd">导出核销记录</div>
                                             <div class="am-modal-bd">
                                                <div class="am-form-group am-cf" style="min-height: 100px;">
                                                    <label class="am-u-sm-2 am-form-label">优惠卷：</label>
                                                    <div class="am-u-sm-9 am-u-end">
                                                        <select id="mollseller"  name="couponid" data-am-selected="{searchBox: 1,maxHeight:200}">
                                                            <option value="">请选择/搜索</option>
                                                            <?php foreach($coupon as $val): ?>
                                                            <option value="<?php echo $val['id'];?>"><?php echo $val['title'].'-'. $val['name']?></option>
                                                            <?php endforeach;?>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="am-form-group am-cf" style="min-height: 100px;">
                                                    <label class="am-u-sm-2 am-form-label">状态</label>
                                                    <div class="am-u-sm-9 am-u-end">
                                                       <select id="" name="state">
                                                            <option value="">请选择</option>
                                                            <option value="2">已使用</option>
                                                            <option value="1">未使用</option>
                                                       </select>
                                                    </div>
                                                </div>
                                                <div class="am-form-group am-cf">
                                                    <label for="businessTime" class="am-u-sm-2 am-form-label">时间：</label>
                                                    <div class="am-u-sm-9 am-u-end">
                                                        <div class="am-alert am-alert-danger" id="lineTime1" style="display: none">
                                                          <p>开始日期应小于结束日期！</p>
                                                        </div>
                                                        <div class="am-g">
                                                          <div class="am-u-sm-6">
                                                            <button type="button" class="am-btn am-btn-default am-btn-secondary am-btn-xs" id="my-start">开始日期</button>
                                                            <input type="hidden" id="starttime" name="starttime" value="" />
                                                            <span id="my-startDate">2017-01-01</span>
                                                          </div>
                                                          <div class="am-u-sm-6">
                                                            <button type="button" class="am-btn am-btn-default am-btn-secondary am-btn-xs" id="my-end">结束日期</button>
                                                            <input type="hidden" id="endtime" name="endtime" value="" />
                                                            <span id="my-endDate">2017-12-31</span>
                                                          </div>
                                                          <small class="red redtips">请先选择结束日期</small>
                                                        </div>
                                                    </div>
                                                    
                                                </div>
                                                <div class="am-form-group am-cf">
                                                    <button class="am-btn am-btn-default am-btn-xs" type="button" data-am-modal-cancel>取消</button>
                                                    <button class="am-btn am-btn-xs am-btn-secondary" type="submit" data-am-modal-confirm>确定</button>
                                                </div>
                                           
                                        </div>
                                       </form>
                                    </div>
                                </div>


                            </div>
          

                        </div>

                    </div>


                    <div class="am-u-sm-12">

                        <table width="100%" class="am-table am-table-compact am-text-nowrap tpl-table-black ">

                            <thead>

                                <tr>

                                    <th class="moll_name">编号</th>
                                    <th class="moll_name">所属城市</th>

                                    <th class="shop_id">名称</th>

                                    <th class="shop_name">标题 </th>

                                    <th class="shop_name">所属商家 </th>

                                    <th class="shop_type">类型 </th>

                                    <th class="shop_yetai">使用期限</th>

                                    <th class="brand">领取数量</th>
                                    <th class="brand">次数限制</th>

                                    <th class="brand">购买价格</th>
                                    <th class="brand">领取数</th>
                                    <th class="brand">核销数</th>
                                    <th class="brand">使用数</th>

                                    <th>操作</th>

                                </tr>

                            </thead>

                            <tbody id="dataList">

                                <!-- more data -->

                            </tbody>

                        </table>

                    </div>

                    <div class="am-u-lg-12 am-cf am-text-center pagebox">

                        <div id="Pagination">

                            <div class="pagination">

                                <a class="prev"><i></i>上一页</a>

                                <a class="current">1</a>

                                <a >2</a>

                                <a>3</a>

                                <a>4</a>

                                <span class="pagination-break">...</span>

                                <a class="ep">15</a>

                                <a class="next">下一页 <i></i></a>

                            </div>

                        </div>

                        <div class="searchPage">

                          <span class="page-sum">共<strong class="allPage">15</strong>页</span>

                          <span class="page-go">跳转<input type="text">页</span>

                          <a href="javascript:;" class="page-btn">确定</a>

                        </div>

                        <div claa="am-text-middle">

                           <span>共<span class="allData">15</span>条数据</span> 

                        </div>

                    </div>

                </div>

            </div>

        </div>

    </div>

</div>

</div>

<div class="goTop"><a href="javascript:scroll(0,0)" type="button"><img src="assets/img/top.png" alt="点我回到顶部"></a></div>

<script type="text/javascript">

$(function() {

    var startDate = new Date(2014, 01, 01);

    var endDate = new Date(2014, 01, 30);

    var $alert = $('#my-alert');


    $('#my-start').datepicker().
      on('changeDate.datepicker.amui', function(event) {
        if (event.date.valueOf() > endDate.valueOf()) {
          $alert.find('p').text('开始日期应小于结束日期！').end().show();
        } else {
          $alert.hide();
          startDate = new Date(event.date);
          $('#my-startDate').text($('#my-start').data('date'));
          // console.log($('#my-start').data('date'));
          $('#starttime').val($('#my-start').data('date'));
        }
        $(this).datepicker('close');
      });

    $('#my-end').datepicker().
      on('changeDate.datepicker.amui', function(event) {
        if (event.date.valueOf() < startDate.valueOf()) {
          $alert.find('p').text('结束日期应大于开始日期！').end().show();
        } else {
          $alert.hide();
          endDate = new Date(event.date);
          $('#my-endDate').text($('#my-end').data('date'));
            // console.log($('#my-end').data('date'));
          $('#endtime').val($('#my-end').data('date'));
        }
        $(this).datepicker('close');
      }); 

      $('#my-start1').datepicker().
      on('changeDate.datepicker.amui', function(event) {
        if (event.date.valueOf() > endDate.valueOf()) {
          $alert.find('p').text('开始日期应小于结束日期！').end().show();
        } else {
          $alert.hide();
          startDate = new Date(event.date);
          $('#my-startDate1').text($('#my-start1').data('date'));
          $('#begin_date1').val($('#my-start1').data('date'));
        }
        $(this).datepicker('close');
      });

    $('#my-end1').datepicker().
      on('changeDate.datepicker.amui', function(event) {
        if (event.date.valueOf() < startDate.valueOf()) {
          $alert.find('p').text('结束日期应大于开始日期！').end().show();
        } else {
          $alert.hide();
          endDate = new Date(event.date);
          $('#my-endDate1').text($('#my-end1').data('date'));
          $('#end_date1').val($('#my-end1').data('date'));
        }
        $(this).datepicker('close');
      }); 

  });




    var total_page = 0,pageflag = 1,current_page=0,$electronicList = parseInt(sessionStorage.getItem('electronicList')) || 0;

    //点击前往某一页的函数

    function go_to_page(page_num){

        $('.page_link').removeClass('active_page');

        $('.page_link').eq(page_num).addClass('active_page');

        $("#dataList").children('tr').css("display","none");

        var start_page=parseInt(15)*parseInt(page_num);

        var end_page=parseInt(15)*parseInt(page_num+1);

        $('#dataList').children('tr').slice(start_page,end_page).css('display','');

        current_page=page_num;

        sessionStorage.setItem('electronicList', current_page);

        $electronicList = parseInt(sessionStorage.getItem('electronicList'));

        

    }



    //点击上一页的函数

    function previous(){

        if($('.current').length>1) {

            new_page = parseInt($('.current').eq(0).html()) - 2;

        }else {

            new_page = parseInt($('.current').html()) - 2;

        }

        if(new_page >= 0) {

            go_to_page(new_page);

        }

    }



    //点击下一页的函数

    function next(argu){

        if($('.current').length>1) {

            new_page = parseInt($('.current').eq(1).html());

        }else {

            new_page = parseInt($('.current').html());

        }

        

        

        if(new_page < argu){   

            console.log(new_page + ' ' + argu);

            go_to_page(new_page);

        }

    }

    //操作函数

    function otherFunction() {

        $('.editElectronic').click(function(){//编辑商品信息

            var dataId=$(this).attr('data-id');

            $(this).attr("href","<?php echo site_url('/electronic/Electronic/editElectronic/" + dataId + "');?>");

        });

        $('.afterSales').click(function(){//查看核销

            var dataId=$(this).attr('data-id');

            $(this).attr("href","<?php echo site_url('/electronic/Electronic/afterSales/"+ dataId +"');?>");

        }); 
        $('.receive').click(function(){//查看领取
            var dataId=$(this).attr('data-id');

            $(this).attr("href","<?php echo site_url('/electronic/Electronic/coupon_electronic/"+ dataId +"');?>");

        });

        for(var i=0;i<$('.tpl-del').length;i++){

            var dataId=$('.tpl-del').eq(i).attr('data-id');

            $('.tpl-del').eq(i).attr("data-am-modal","{target: '#"+ dataId +"'}");                         

        }

        //删除优惠券的AJAX请求

        $('.sureDelete').click(function(){

            var dataId=$(this).attr('data-id');

            $.ajax({

                type:'post',

                url:'<?php echo site_url('/electronic/Electronic/del_coupon');?>',

                data: 'id='+dataId,

                success: function(data){

                    if(data==1){                 

                       $('#trClass'+dataId).remove();

                    }else{

                        alert("操作失败，请检查网络设置！");

                    }
                },

                error:function(xhr,type,errorThrown){

                    alert("操作失败，请检查网络设置！");

                }

            });

        });

    }

    //异步刷新的ajax请求   

    function getList(dataurl,data){

        $.ajax({

            type:'post',

            url:dataurl,

            data: data,

            success: function(result){   
                //    console.log(result);      

                var res = JSON.parse(result);

                // console.log(res);

                if(res != 2 && res != 3){

                    var listData = ''; //每页出现的数量

                    total_page = Math.ceil(res.length/15); //得到总页数


                    for(var i = 0; i < res.length; i++){

                        listData += template('dataModal',res[i]);

                    }

                    document.getElementById('dataList').innerHTML = listData;

                    $('.allData').html(res.length);

                    $('.pagebox').css('display', 'block');

                    if(total_page <= 1) {

                        $('#Pagination').css('display', 'none');

                        $('.searchPage').css('display', 'none');

                    } else {

                        if(pageflag) {

                            var opts={};

                            opts.current_page = $electronicList;

                            $("#Pagination").pagination(total_page, opts);

                            go_to_page($electronicList);

                            pageflag = 0;

                        } else {
                            $("#Pagination").pagination(total_page);
                            go_to_page(0);
                        }

                        if(total_page < 5) {

                            $('.searchPage').css('display', 'none');

                        }

                    }

                    

                    otherFunction();

                }else{

                    $('#dataList').find('tr').remove();

                    $('<tr class="trClass"><td colspan="12" class="am-text-center"><p id="nullMessage">暂无电子券信息！</p></td></tr>').appendTo('#dataList');

                    $('.pagebox').css('display', 'none');

                }         

            },

            error:function(xhr,type,errorThrown){

                alert("网络状况不佳，请稍后重试！");

                $('#dataList').find('tr').remove();

                $('<tr class="trClass"><td colspan="12" class="am-text-center"><p id="nullMessage">暂无电子券信息！</p></td></tr>').appendTo('#dataList');

                $('.pagebox').css('display', 'none');

            }

        });

    }

$(document).ready(function(){

    //加载列表数数据

    getList('<?php echo site_url('/electronic/Electronic/get_electr_list');?>','default=1');

    //点击搜索

    $('.searchSales').click(function(){

        var city=$('#city option:selected').val(),store_id=$('#store_id option:selected').val();
        console.log(city,store_id);
     
        getList('<?php echo site_url('/electronic/Electronic/search_electronic');?>','city='+city+'&store_id='+store_id);

    });

})

</script>

<script type="text/html" id="dataModal">

    <tr class="trClass" id="trClass<%= id%>" data-id="<%= id%>">

        <td class="am-text-middle"><%= id%></td>
        <%if(city == '1'){%>
            <td>重庆</td>
        <%}else if(city == '2'){%>
            <td>南江</td>
        <%}else if(city == '3'){%>
            <td>宣汉</td>
        <%}else if(city == '4'){%>
            <td>邻水</td>
        <%}else if(city == '0'){%>
            <td>电商通用卷</td>
        <%}%>
        <td class="am-text-middle"><%= name%></td>

        <td class="am-text-middle"><%if(isGamePrize == '1'){%>游戏使用-<%}else if(isGamePrize == '2'){%>分享专用-<%}else if(isGamePrize =='3'){%>爱购专用-<%}%><%= title%></td>

         <%if(storename == ',') {%>

        <td class="am-text-middle">宏帆广场</td>

        <%}else{%>

        <td class="am-text-middle"><%= storename%></td>

        <%}%>

        <%if(typeid=="1") {%>

        <td class="am-text-middle">电商抵扣券</td>

        <%}else if(typeid=="2") {%>

        <td class="am-text-middle">电商折扣券</td>  
        <%}else if(typeid=="3") {%>

        <td class="am-text-middle">电商满减券</td>

        <%}else {%>


        <td class="am-text-middle">线下团购券</td>

        <%}%>

        <td class="am-text-middle"><%= begin_date%>至<%= end_date%></td>

        <%if(receive_limit=="1") {%>
        <td class="am-text-middle">一张</td>
        <%}else {%>
        <td class="am-text-middle">不限制</td>
        <%}%>
        <%if(frequency=="1") {%>
        <td class="am-text-middle">一天一次</td>
        <%}else if(frequency=="2") {%>
        <td class="am-text-middle">两天一次</td> 
        <%}else if(frequency=="7") {%>
        <td class="am-text-middle">一周一次</td> 
        <%}else if(frequency=="30") {%>
        <td class="am-text-middle">一月一次</td>
        <%}else {%>
        <td class="am-text-middle">仅领一次</td>
        <%}%>
        <td><%= price%></td>

        <% if(lin == ''){%>
            <td>0</td>
        <%}else{%>
            <td><%= lin%></td>
        <%}%>

        <% if(he == ''){%>
            <td>0</td>
        <%}else{%>
            <td><%= he%></td>
        <%}%> 
        <% if(receive == ''){%>
            <td>0</td>
        <%}else{%>
            <td><%= receive%></td>
        <%}%>
    
    


        <td class="am-text-middle">

            <div class="tpl-table-black-operation">
                <a data-id="<%= id%>" class="receive">

                    <i class="am-icon-eye"></i> 查看领取信息

                </a>

                <a data-id="<%= id%>" class="afterSales">

                    <i class="am-icon-eye"></i> 查看核销信息

                </a>

                <a data-id="<%= id%>" class="editElectronic">

                    <i class="am-icon-pencil"></i> 编辑

                </a>

                <a data-id="<%= id%>" class="tpl-table-black-operation-del tpl-del">

                    <i class="am-icon-trash"></i> 删除

                </a>

            </div>

        </td>

    </tr>

     <div class="am-modal am-modal-confirm" tabindex="-1" id="<%= id%>">

        <div class="am-modal-dialog">

            <div class="am-modal-hd">删除提示</div>

            <div class="am-modal-bd">

                <p class="black">你，确定要删除这条记录吗？</p>

            </div>

            <div class="am-modal-footer">

                <span class="am-modal-btn" data-am-modal-cancel>取消</span>

                <span class="am-modal-btn sureDelete" data-id="<%= id%>" data-am-modal-confirm>确定</span>

            </div>

        </div>

    </div>

</script>



